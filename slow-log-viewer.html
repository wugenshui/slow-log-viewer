<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL慢查询日志分析</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .file-input-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
        }
        .file-input-container.drag-over {
            background-color: #e9ecef;
            border-color: #6c757d;
        }
        #fileInput {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .file-label:hover {
            background-color: #0056b3;
        }
        #queryList {
            margin: 20px 0;
        }
        .query-item {
            padding: 15px;
            margin: 10px 0;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .query-item:hover {
            background-color: #e9ecef;
        }
        .query-item .summary {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .query-details-preview {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .query-details-preview.expanded {
            display: block;
        }
        .sql-preview {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .metrics-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .metric-item {
            background-color: #fff;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .metrics-card {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .query-details {
            background-color: #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        #detailView {
            display: none;
        }
        .back-button {
            margin-bottom: 20px;
            padding: 8px 16px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .back-button:hover {
            background-color: #5a6268;
        }
        .chart-container {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            height: 400px;
        }
        .mini-chart {
            width: 300px;
            height: 100px;
            flex-shrink: 0;
        }
        .query-info {
            flex-grow: 1;
        }
        .overview-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .overview-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .overview-chart {
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MySQL慢查询日志分析</h1>
        
        <div class="file-input-container" id="dropZone">
            <input type="file" id="fileInput" accept=".json">
            <label for="fileInput" class="file-label">选择慢查询日志文件</label>
            <p>或将文件拖放到此处</p>
        </div>

        <div id="listView">
            <div class="overview-container">
                <div class="overview-card">
                    <h3>查询统计</h3>
                    <div>
                        <p><strong>总查询数:</strong> <span id="totalQueries">0</span></p>
                        <p><strong>平均执行时间:</strong> <span id="avgQueryTime">0</span>秒</p>
                        <p><strong>最长执行时间:</strong> <span id="maxQueryTime">0</span>秒</p>
                    </div>
                    <div id="queryStatsChart" class="overview-chart"></div>
                </div>
                <div class="overview-card">
                    <h3>执行时间分布</h3>
                    <div id="timeDistChart" class="overview-chart"></div>
                </div>
                <div class="overview-card">
                    <h3>查询类型分布</h3>
                    <div id="queryTypeChart" class="overview-chart"></div>
                </div>
            </div>
            <h2>查询列表</h2>
            <div id="queryList"></div>
        </div>

        <div id="detailView">
            <button class="back-button" onclick="showListView()">返回列表</button>
            <div class="metrics-card">
                <h2>查询指纹信息</h2>
                <p><strong>指纹:</strong> <code id="fingerprint"></code></p>
                <p><strong>校验和:</strong> <span id="checksum"></span></p>
            </div>

            <div class="metrics-card">
                <h2>查询示例</h2>
                <div class="query-details" id="example"></div>
            </div>

            <div class="metrics-card">
                <h2>性能指标</h2>
                <table id="metricsTable">
                    <thead>
                        <tr>
                            <th>指标</th>
                            <th>最小值</th>
                            <th>最大值</th>
                            <th>平均值</th>
                            <th>中位数</th>
                            <th>95分位</th>
                            <th>标准差</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="metrics-card">
                <h2>性能分析图表</h2>
                <div class="chart-container">
                    <canvas id="queryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let globalData = null;
        let myChart = null;

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    // 尝试处理可能的编码问题
                    const decodedText = decodeURIComponent(escape(text));
                    globalData = JSON.parse(decodedText);
                    displayQueryList(globalData);
                } catch (error) {
                    try {
                        // 如果上面的解码失败，直接尝试解析原始文本
                        globalData = JSON.parse(text);
                        displayQueryList(globalData);
                    } catch (e) {
                        alert('文件解析错误：' + e.message);
                    }
                }
            };
            reader.readAsText(file, 'UTF-8'); // 明确指定UTF-8编码
        }

        function displayQueryList(data) {
            const queryList = document.getElementById('queryList');
            queryList.innerHTML = '';
            
            data.classes.forEach((queryClass, index) => {
                const div = document.createElement('div');
                div.className = 'query-item';
                
                const executionCount = getQueryCount(queryClass);
                const metrics = queryClass.metrics.Query_time;
                
                div.innerHTML = `
                    <div class="summary">
                        <div class="query-info">
                            <strong>查询时间:</strong> ${queryClass.example.Query_time}秒
                            <br>
                            <small>${queryClass.fingerprint.substring(0, 100)}...</small>
                        </div>
                        <div>
                            <strong>执行次数:</strong> ${executionCount}次
                            <br>
                            <strong>平均执行时间:</strong> ${metrics.avg}秒
                        </div>
                    </div>
                    <div class="query-details-preview">
                        <h4>SQL语句</h4>
                        <div class="sql-preview">${queryClass.example.query}</div>
                        
                        <h4>性能指标</h4>
                        <div class="metrics-preview">
                            <div class="metric-item">
                                <strong>最小执行时间:</strong> ${metrics.min}秒
                            </div>
                            <div class="metric-item">
                                <strong>最大执行时间:</strong> ${metrics.max}秒
                            </div>
                            <div class="metric-item">
                                <strong>平均执行时间:</strong> ${metrics.avg}秒
                            </div>
                            <div class="metric-item">
                                <strong>中位数时间:</strong> ${metrics.median}秒
                            </div>
                            <div class="metric-item">
                                <strong>95分位时间:</strong> ${metrics.pct_95}秒
                            </div>
                            <div class="metric-item">
                                <strong>标准差:</strong> ${metrics.stddev}秒
                            </div>
                            <div class="metric-item">
                                <strong>总执行次数:</strong> ${executionCount}次
                            </div>
                        </div>
                    </div>
                `;

                // 点击展开/收起详情
                div.querySelector('.summary').addEventListener('click', function(e) {
                    const details = div.querySelector('.query-details-preview');
                    details.classList.toggle('expanded');
                    e.stopPropagation(); // 防止触发父元素的点击事件
                });

                // 双击进入详情页
                div.addEventListener('dblclick', () => showDetailView(index));
                
                queryList.appendChild(div);
            });
        }

        function getQueryCount(queryClass) {
            // 从直方图数据中计算总次数
            if (queryClass.histograms && queryClass.histograms.Query_time) {
                return queryClass.histograms.Query_time.reduce((a, b) => a + b, 0);
            }
            return 'N/A';
        }

        function showDetailView(index) {
            const queryClass = globalData.classes[index];
            document.getElementById('listView').style.display = 'none';
            document.getElementById('detailView').style.display = 'block';
            displayData(queryClass);
        }

        function showListView() {
            document.getElementById('listView').style.display = 'block';
            document.getElementById('detailView').style.display = 'none';
        }

        function displayData(queryClass) {
            // 填充指纹信息
            document.getElementById('fingerprint').textContent = queryClass.fingerprint;
            document.getElementById('checksum').textContent = queryClass.checksum;
            
            // 添加执行次数显示
            const executionCount = getQueryCount(queryClass);
            document.querySelector('.metrics-card').innerHTML += `
                <p><strong>总执行次数:</strong> ${executionCount}次</p>
            `;
            
            // 填充示例查询
            const example = queryClass.example;
            document.getElementById('example').textContent = 
                `查询时间: ${example.Query_time}
查询语句: ${example.query}
时间戳: ${example.ts}`;
            
            // 填充性能指标表格
            const tbody = document.querySelector('#metricsTable tbody');
            tbody.innerHTML = '';
            const metrics = queryClass.metrics;
            
            for (const [metricName, values] of Object.entries(metrics)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${getMetricDisplayName(metricName)}</td>
                    <td>${values.min}</td>
                    <td>${values.max}</td>
                    <td>${values.avg}</td>
                    <td>${values.median}</td>
                    <td>${values.pct_95}</td>
                    <td>${values.stddev}</td>
                `;
                tbody.appendChild(row);
            }

            // 创建图表
            createChart(queryClass);
        }

        function getMetricDisplayName(name) {
            const displayNames = {
                'Query_time': '查询时间',
                'Lock_time': '锁定时间',
                'Rows_examined': '扫描行数',
                'Rows_sent': '返回行数',
                'Query_length': '查询长度'
            };
            return displayNames[name] || name;
        }

        function createChart(queryClass) {
            const chartDom = document.getElementById('queryChart');
            if (myChart) {
                myChart.dispose();
            }
            myChart = echarts.init(chartDom);
            
            // 准备数据
            const histogramData = queryClass.histograms.Query_time;
            const labels = [];
            const microseconds = [0.000001, 0.000010, 0.000100, 0.001000, 0.010000, 0.100000, 1.000000, 10.000000, 100.000000, 1000.000000];
            
            for (let i = 0; i < histogramData.length; i++) {
                if (i === histogramData.length - 1) {
                    labels.push(`>${microseconds[i].toFixed(6)}s`);
                } else {
                    labels.push(`${microseconds[i].toFixed(6)}s-${microseconds[i+1].toFixed(6)}s`);
                }
            }

            // 计算累计百分比
            const total = histogramData.reduce((a, b) => a + b, 0);
            let accumulator = 0;
            const percentages = histogramData.map(count => {
                accumulator += (count / total) * 100;
                return accumulator.toFixed(2);
            });

            const option = {
                title: {
                    text: '查询执行时间分布',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let result = `${params[0].name}<br/>`;
                        params.forEach(param => {
                            const value = param.seriesName === '执行次数' 
                                ? param.value + '次'
                                : param.value + '%';
                            result += `${param.marker} ${param.seriesName}: ${value}<br/>`;
                        });
                        return result;
                    }
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none'
                        },
                        restore: {},
                        saveAsImage: {}
                    }
                },
                legend: {
                    data: ['执行次数', '累计百分比'],
                    top: 25
                },
                xAxis: {
                    type: 'category',
                    data: labels,
                    axisLabel: {
                        interval: 0,
                        rotate: 45
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '执行次数',
                        position: 'left',
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#5470C6'
                            }
                        },
                        axisLabel: {
                            formatter: '{value}次'
                        }
                    },
                    {
                        type: 'value',
                        name: '累计百分比',
                        position: 'right',
                        max: 100,
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#EE6666'
                            }
                        },
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    }
                ],
                series: [
                    {
                        name: '执行次数',
                        type: 'bar',
                        data: histogramData,
                        itemStyle: {
                            color: '#5470C6'
                        }
                    },
                    {
                        name: '累计百分比',
                        type: 'line',
                        yAxisIndex: 1,
                        data: percentages,
                        itemStyle: {
                            color: '#EE6666'
                        },
                        lineStyle: {
                            width: 2
                        },
                        symbol: 'circle',
                        symbolSize: 8
                    }
                ],
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%'
                }
            };

            myChart.setOption(option);

            // 响应窗口大小变化
            window.addEventListener('resize', function() {
                myChart && myChart.resize();
            });
        }

        // 文件选择处理
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // 拖放功能
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });
    </script>
</body>
</html> 